<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login / Crear cuenta - Tienda Tech Perú</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>

    <div class="auth-container" role="main">
        <div class="auth-card" id="login-view" aria-hidden="true">
            <h2 class="auth-title">Iniciar sesión</h2>
                <form id="form-login" autocomplete="on">
        <div class="form-group">
            <label for="login-identifier">Usuario o correo</label>
            <input id="login-identifier" name="login-identifier" type="text" required placeholder="usuario o correo@example.com" />
        </div>

        <div class="form-group">
            <label for="login-password">Contraseña</label>
            <input id="login-password" name="login-password" type="password" required placeholder="contraseña" />
        </div>

        <div class="actions">
            <button type="submit" class="btn">Iniciar sesión</button>
            <button id="show-register" type="button" class="link-switch">Crear cuenta</button>
        </div>
        <p class="small">Si aún no tienes cuenta, usa "Crear cuenta" abajo.</p>
        </form>
    </div>

    <div class="auth-card" id="register-view" aria-hidden="true" style="display:none;">
        <h2 class="auth-title">Crear cuenta</h2>
        <form id="form-register" autocomplete="on">
        <div class="form-group">
            <label for="reg-nombre">Nombre completo</label>
            <input id="reg-nombre" name="reg-nombre" type="text" required placeholder="Ej: Michel Rojas" autocomplete="name" required />
        </div>

        <div class="form-group">
            <label for="reg-email">Correo electrónico</label>
            <input id="reg-email" name="reg-email" type="email" required placeholder="michel@gmail.com" autocomplete="email" required/>
        </div>

        <div class="form-group">
            <label for="reg-password">Contraseña</label>
            <input id="reg-password" name="reg-password" type="password" required placeholder="contraseña" required />
        </div>

        <div class="form-group">
            <label for="reg-password2">Confirmar contraseña</label>
            <input id="reg-password2" name="reg-password2" type="password" required placeholder="repite la contraseña" required />
        </div>

        <div class="actions">
            <button type="submit" class="btn">Confirmar</button>
            <button id="show-login" type="button" class="link-switch">Volver a iniciar sesión</button>
        </div>
        <p class="small">Al crear una cuenta aceptas nuestros terminos y Condiciones.</p>
        </form>
    </div>
    </div>

<script>
(function () {
    // Utils para manejar cuentas en localStorage
    function obtenerCuentas() {
    try {
        const raw = localStorage.getItem('cuentas');
        return raw ? JSON.parse(raw) : [];
    } catch (e) {
        return [];
    }
    }
    function guardarCuentas(cuentas) {
    localStorage.setItem('cuentas', JSON.stringify(cuentas));
    }

    // Elementos
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const formLogin = document.getElementById('form-login');
    const formRegister = document.getElementById('form-register');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');

    // Mostrar vista inicial según parámetro
    const params = new URLSearchParams(window.location.search);
    const initialView = params.get('view') === 'register' ? 'register' : 'login';

    function mostrarLogin() {
        loginView.style.display = '';
        registerView.style.display = 'none';
        loginView.setAttribute('aria-hidden', 'false');
        registerView.setAttribute('aria-hidden', 'true');
    }
    function mostrarRegister() {
        loginView.style.display = 'none';
        registerView.style.display = '';
        loginView.setAttribute('aria-hidden', 'true');
        registerView.setAttribute('aria-hidden', 'false');
    }

    if (initialView === 'register') mostrarRegister(); else mostrarLogin();

    // Switch buttons
    showRegister && showRegister.addEventListener('click', function () { mostrarRegister(); });
    showLogin && showLogin.addEventListener('click', function () { mostrarLogin(); });

    // LOGIN
    formLogin && formLogin.addEventListener('submit', function (e) {
    e.preventDefault();
        const identifier = document.getElementById('login-identifier').value.trim();
        const password = document.getElementById('login-password').value;

    if (!identifier || !password) {
        alert('Por favor completa todos los campos.');
        return;
        }

    const cuentas = obtenerCuentas();
    const cuenta = cuentas.find(c => (c.email === identifier || c.nombre === identifier) && c.password === password);

    if (!cuenta) {
        alert('Credenciales incorrectas o la cuenta no existe. Si no tienes cuenta, crea una.');
        return;
    }

      // Login OK 
    localStorage.setItem('usuario_logged', 'true');
    localStorage.setItem('usuario_nombre', cuenta.nombre);
    localStorage.setItem('last_login_time', Date.now());

    alert('Inicio de sesión exitoso. Bienvenido, ' + cuenta.nombre + '!');
    if (window.parent) {
        window.parent.postMessage('login_success', '*');
    }
    });

    // REGISTER
    formRegister && formRegister.addEventListener('submit', function (e) {
    e.preventDefault();
    const nombre = document.getElementById('reg-nombre').value.trim();
    const email = document.getElementById('reg-email').value.trim().toLowerCase();
    const pass1 = document.getElementById('reg-password').value;
    const pass2 = document.getElementById('reg-password2').value;

    if (!nombre || !email || !pass1 || !pass2) {
        alert('Por favor completa todos los campos.');
        return;
    }
    if (pass1 !== pass2) {
        alert('Las contraseñas no coinciden.');
        return;
    }

    const cuentas = obtenerCuentas();
    const exists = cuentas.some(c => c.email === email || c.nombre === nombre);
    if (exists) {
        alert('Ya existe una cuenta con ese email o nombre. Intenta iniciar sesión o usa otro email/nombre.');
        return;
    }

      // Guardar nueva cuenta 
    cuentas.push({ nombre: nombre, email: email, password: pass1 });
    guardarCuentas(cuentas);
    alert('Cuenta creada correctamente.');
    if (window.parent) {
        window.parent.postMessage('login_success', '*');
    }
    });

    // Permitir cierre con Es
    window.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
        
        try {
            if (window.parent && window.parent.document.getElementById('iframe-close')) {
            window.parent.document.getElementById('iframe-close').click();
            }
        } catch (err) { /* noop */ }
    }
    });
    })();
</script>
</body>
</html>
